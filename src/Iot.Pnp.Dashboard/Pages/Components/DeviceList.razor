@using System.Reactive.Linq
@using Iot.PnpDashboard.Devices
@inject IDeviceService DeviceService
@implements IDisposable

<div class="list-stream-container">
    @if (_devicesToShow is not null)
    {
        <div>
            <p>Online Devices: <label>@_onlineDevicesCount</label></p>
            <div class="inline-fields">
                <p>
                    Showing page <label>@_currentPage</label> of <label>@( _pages )</label>
                    <button class="btn btn-primary" onclick="@(async () => await DecrementPage())">Page --</button> 
                    <button class="btn btn-primary" onclick="@(async () => await IncrementPage())">Page ++</button> 
                    Filter by DeviceId: <input type="text" @bind="_nameFilter" />
                    Page Size: <input type="text" @bind="_pageSize"/> 
                    <button class="btn btn-primary" onclick="@(async () => await ApplyFilter())">Apply</button>
                    <label hidden="@(!_showLoading)">&nbsp;&nbsp;Loading...</label>
                </p>
            </div>
        </div>
        if (_devicesToShow.Count > 0)
        {
            <table class="table">
                <tr>
                    <th scope="col">Device Id</th>
                    <th scope="col">Model Id</th>
                    <th scope="col">Last Operation</th>
                    <th scope="col">Op. Source</th>
                    <th scope="col">Last Telemetry</th>
                    <th scope="col">Connected</th>
                </tr>

                @foreach (var item in _devicesToShow)
                {
                    <tr>
                        <td><a href=/device/@item.DeviceId>@item.DeviceId</a></td>
                        <td>@item.ModelId</td>
                        <td>@(item.LastOperation is not null ? $"{ item.LastOperation } [{ item.LastOperationTimestamp }]" : "-")</td>
                        <td>@(item.LastOperation is not null ? item.MessageSource : "-")</td>
                        <td>@item.LastTelemetryTimestamp</td>
                        <td>@(!item.Disconnected) @((item.Disconnected.HasValue && !item.Disconnected.Value) && (item.LastTelemetryTimestamp != null && (item.LastTelemetryTimestamp < DateTime.UtcNow.AddMinutes(-5))) ? "?" : "")</td>
                    </tr>
                }
            </table>
            <div>

            </div>
        }
        else
        {
            <div class="alert alert-primary" role="alert">
                Waiting for devices...
            </div>
        }
    }
</div>
@code {
    Timer? _timer;
    List<Device>? _devicesToShow;
    private const int DefaultPageSize = 20;
    private string? _nameFilter { get; set; }
    private int _pageSize { get; set; }
    private int _currentPage { get; set; }
    private int _pages { get; set; }
    private long _onlineDevicesCount;
    private bool _showLoading = false;


    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        _pageSize = DefaultPageSize;
        _currentPage = 1;
        _onlineDevicesCount = await DeviceService.OnlineDevicesCountAsync();
        _pages = _pageSize > 0 ? Convert.ToInt32(Math.Ceiling(Convert.ToDouble(_onlineDevicesCount) / _pageSize)) : DefaultPageSize;
        await RefreshUI();
        _timer = new Timer(async (object? stateInfo) =>
        {
            await RefreshUI();
        }, new System.Threading.AutoResetEvent(false), 0, 1000);
    } 

    private async Task ApplyFilter()
    {
        _showLoading = true;
        if (!String.IsNullOrWhiteSpace(_nameFilter))
        {
            _nameFilter = _nameFilter.StartsWith('*') ? _nameFilter?.TrimStart('*') : _nameFilter;
        }

        if(_pageSize < 1)
        {
            _pageSize = DefaultPageSize;
        }

        await RefreshUI();
        _showLoading = false;
    }
    private async Task IncrementPage()
    {
        if(_currentPage < _pages)
        {
            _showLoading = true;
            _currentPage++;
            await RefreshUI();
            _showLoading = false;
        }
    }
    private async Task DecrementPage()
    {
    if(_currentPage > 0)
        {
            _showLoading = true;
            _currentPage--;
            await RefreshUI();
            _showLoading = false;
        }
    }
    private async Task RefreshUI()
    {
        await InvokeAsync(async () =>
        {
            _devicesToShow = (await DeviceService.GetOnlineDevicesAsync(_nameFilter, _pageSize, _currentPage-1)).ToList();
            _onlineDevicesCount = await DeviceService.OnlineDevicesCountAsync();
            _pages = _pageSize > 0 ? Convert.ToInt32(Math.Ceiling(Convert.ToDouble(_onlineDevicesCount) / _pageSize)) : DefaultPageSize;
            StateHasChanged();
        });
    }

    public void Dispose()
    {
        _timer?.Dispose();
    }
}