@using System.Reactive.Linq
@using Iot.PnpDashboard.Devices
@inject IDeviceService DeviceService
@implements IDisposable

<div class="list-stream-container">
    @if (DeviceService.OnlineDevices is not null)
    {
        if (DeviceService.OnlineDevices.Count() > 0)
        {
            <table class="table">
                <tr>
                    <th scope="col">Device Id</th>
                    <th scope="col">Model Id</th>
                    <th scope="col">Last Operation</th>
                    <th scope="col">Op. Source</th>
                    <th scope="col">Last Telemetry</th>
                    <th scope="col">Connected</th>
                </tr>

                @foreach (var item in DeviceService.OnlineDevices.OrderBy(d => d.DeviceId))
                {
                    <tr>
                        <td><a href=/device/@item.DeviceId>@item.DeviceId</a></td>
                        <td>@item.ModelId</td>
                        <td>@(item.LastOperation is not null ? $"[{ item.LastOperationTimestamp }] { item.LastOperation }" : "-")</td>
                        <td>@(item.LastOperation is not null ? item.MessageSource : "-")</td>
                        <td>@item.LastTelemetryTimestamp</td>
                        <td>@(!item.Disconnected) @((item.Disconnected.HasValue && !item.Disconnected.Value) && (item.LastTelemetryTimestamp != null && (item.LastTelemetryTimestamp < DateTime.UtcNow.AddMinutes(-5))) ? "?" : "")</td>
                    </tr>
                }
            </table>

        }
        else
        {
            <div class="alert alert-primary" role="alert">
                Waiting for devices...
            </div>
        }
    }
</div>
@code {
    Timer? _timer;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        _timer = new Timer(async (object? stateInfo) =>
        {
            await RefreshUI();
        }, new System.Threading.AutoResetEvent(false), 0, 1000);
    }

    private async Task RefreshUI()
    {
        await InvokeAsync(() => StateHasChanged());
    }

    public void Dispose()
    {
        _timer?.Dispose();
    }
}